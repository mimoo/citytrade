<script setup>

import { computed, ref, onMounted, watch, toRefs } from 'vue'
import axios from 'axios';
import {
    LMap,
    LIcon,
    LTileLayer,
    LMarker,
    LControlLayers,
    LTooltip,
    LPopup,
    LPolyline,
    LPolygon,
    LRectangle,
} from "@vue-leaflet/vue-leaflet";
import "leaflet/dist/leaflet.css";
import { useStore } from '@/stores/cities'

//
// Map stuff
//

const zoom = ref(2);

async function get_city_coords(city, country) {
    // 
    const resp = await axios
        .get(`https://nominatim.openstreetmap.org/search?q=${city},${country}&format=json`);
    const data = resp.data;
    if (data.length == 0) {
        return null;
    }

    return {
        lat: data[0].lat,
        lon: data[0].lon
    };
}

window.get_city_coords = get_city_coords;

//
//
//

const CACHED_CITY_COORDS = [{ "city_id": "0", "name": "Paris", "coords": { "lat": "48.8566969", "lon": "2.3514616" } }, { "city_id": "1", "name": "Moscow", "coords": { "lat": "55.7504461", "lon": "37.6174943" } }, { "city_id": "2", "name": "Beijing", "coords": { "lat": "39.906217", "lon": "116.3912757" } }, { "city_id": "3", "name": "London", "coords": { "lat": "51.5073219", "lon": "-0.1276474" } }, { "city_id": "4", "name": "New York", "coords": { "lat": "40.7127281", "lon": "-74.0060152" } }, { "city_id": "5", "name": "Toronto", "coords": { "lat": "43.6534817", "lon": "-79.3839347" } }, { "city_id": "6", "name": "Seoul", "coords": { "lat": "37.5666791", "lon": "126.9782914" } }, { "city_id": "7", "name": "Tokyo", "coords": { "lat": "35.6828387", "lon": "139.7594549" } }, { "city_id": "8", "name": "Bucharest", "coords": { "lat": "44.4361414", "lon": "26.1027202" } }, { "city_id": "9", "name": "Craiova", "coords": { "lat": "44.3190159", "lon": "23.7965614" } }, { "city_id": "10", "name": "Amsterdam", "coords": { "lat": "52.3727598", "lon": "4.8936041" } }, { "city_id": "11", "name": "Madrid", "coords": { "lat": "40.4167047", "lon": "-3.7035825" } }, { "city_id": "12", "name": "Berlin", "coords": { "lat": "52.5170365", "lon": "13.3888599" } }, { "city_id": "13", "name": "Pyongyang", "coords": { "lat": "39.0167979", "lon": "125.7473609" } }, { "city_id": "14", "name": "Singapore", "coords": { "lat": "1.357107", "lon": "103.8194992" } }, { "city_id": "15", "name": "Dubai", "coords": { "lat": "25.2653471", "lon": "55.2924914" } }, { "city_id": "16", "name": "Stockholm", "coords": { "lat": "59.3251172", "lon": "18.0710935" } }, { "city_id": "17", "name": "Chicago", "coords": { "lat": "41.8755616", "lon": "-87.6244212" } }, { "city_id": "18", "name": "Lyon", "coords": { "lat": "45.7578137", "lon": "4.8320114" } }, { "city_id": "19", "name": "Hong Kong", "coords": { "lat": "22.2793278", "lon": "114.1628131" } }, { "city_id": "20", "name": "San Francisco", "coords": { "lat": "37.7790262", "lon": "-122.419906" } }, { "city_id": "21", "name": "Shanghai", "coords": { "lat": "31.2322758", "lon": "121.4692071" } }, { "city_id": "22", "name": "Chiayi", "coords": { "lat": "23.4811089", "lon": "120.4535412" } }, { "city_id": "23", "name": "Harbin", "coords": { "lat": "45.7988273", "lon": "126.5303997" } }, { "city_id": "24", "name": "Jaipur", "coords": { "lat": "26.9154576", "lon": "75.8189817" } }, { "city_id": "25", "name": "Casablanca", "coords": { "lat": "33.5950627", "lon": "-7.6187768" } }, { "city_id": "26", "name": "Rio de Janeiro", "coords": { "lat": "-22.9110137", "lon": "-43.2093727" } }, { "city_id": "27", "name": "Cordoba", "coords": { "lat": "-31.4173391", "lon": "-64.183319" } }, { "city_id": "28", "name": "Kisangani", "coords": { "lat": "0.5073896", "lon": "25.1951273" } }, { "city_id": "29", "name": "Sydney", "coords": { "lat": "-33.8548157", "lon": "151.2164539" } }, { "city_id": "30", "name": "Almaty", "coords": { "lat": "43.2363924", "lon": "76.9457275" } }, { "city_id": "31", "name": "Istanbul", "coords": { "lat": "41.0096334", "lon": "28.9651646" } }, { "city_id": "32", "name": "Quebec", "coords": { "lat": "52.4760892", "lon": "-71.8258668" } }, { "city_id": "33", "name": "Abu Dhabi", "coords": { "lat": "24.4538352", "lon": "54.3774014" } }, { "city_id": "34", "name": "Kiev", "coords": { "lat": "50.4500336", "lon": "30.5241361" } }, { "city_id": "35", "name": "Johannesburg", "coords": { "lat": "-26.205", "lon": "28.049722" } }, { "city_id": "36", "name": "Phuket", "coords": { "lat": "7.9366015", "lon": "98.3529292" } }, { "city_id": "37", "name": "Lagos", "coords": { "lat": "6.4550575", "lon": "3.3941795" } }, { "city_id": "38", "name": "Reykjavik", "coords": { "lat": "64.145981", "lon": "-21.9422367" } }, { "city_id": "39", "name": "Vancouver", "coords": { "lat": "49.2608724", "lon": "-123.113952" } }, { "city_id": "40", "name": "Atlanta", "coords": { "lat": "33.7489924", "lon": "-84.3902644" } }, { "city_id": "41", "name": "Perth", "coords": { "lat": "-31.9527121", "lon": "115.8604796" } }, { "city_id": "42", "name": "Bangkok", "coords": { "lat": "13.7544238", "lon": "100.4930399" } }, { "city_id": "43", "name": "Granada", "coords": { "lat": "37.1734995", "lon": "-3.5995337" } }, { "city_id": "44", "name": "Tunis", "coords": { "lat": "33.8439408", "lon": "9.400138" } }, { "city_id": "45", "name": "Budapest", "coords": { "lat": "47.4979937", "lon": "19.0403594" } }, { "city_id": "46", "name": "Bordeaux", "coords": { "lat": "44.841225", "lon": "-0.5800364" } }, { "city_id": "47", "name": "Seattle", "coords": { "lat": "47.6038321", "lon": "-122.3300624" } }, { "city_id": "48", "name": "Newcastle", "coords": { "lat": "54.9738474", "lon": "-1.6131572" } }, { "city_id": "49", "name": "Cologne", "coords": { "lat": "50.938361", "lon": "6.959974" } }, { "city_id": "50", "name": "Halifax", "coords": { "lat": "44.648618", "lon": "-63.5859487" } }, { "city_id": "51", "name": "Scottsdale", "coords": { "lat": "33.4942189", "lon": "-111.9260184" } }, { "city_id": "52", "name": "Hamilton", "coords": { "lat": "43.2560802", "lon": "-79.8728583" } }, { "city_id": "53", "name": "Bologna", "coords": { "lat": "44.4938203", "lon": "11.3426327" } }, { "city_id": "54", "name": "Zug", "coords": { "lat": "47.1486137", "lon": "8.5539378" } }, { "city_id": "55", "name": "Gaborone", "coords": { "lat": "-24.6581357", "lon": "25.9088474" } }, { "city_id": "56", "name": "Nagoya", "coords": { "lat": "35.1851045", "lon": "136.8998438" } }, { "city_id": "57", "name": "Turin", "coords": { "lat": "45.0677551", "lon": "7.6824892" } }, { "city_id": "58", "name": "Espoo", "coords": { "lat": "60.2241869", "lon": "24.6603626" } }, { "city_id": "59", "name": "Bergen", "coords": { "lat": "60.3943055", "lon": "5.3259192" } }, { "city_id": "60", "name": "Windhoek", "coords": { "lat": "-22.5743922", "lon": "17.0790688" } }, { "city_id": "61", "name": "Santo Domingo", "coords": { "lat": "18.4801972", "lon": "-69.942111" } }, { "city_id": "62", "name": "Carrefour", "coords": { "lat": "18.5345373", "lon": "-72.4092495" } }, { "city_id": "63", "name": "Port-au-Prince", "coords": { "lat": "18.547327", "lon": "-72.3395928" } }, { "city_id": "64", "name": "Bristol", "coords": { "lat": "51.4538022", "lon": "-2.5972985" } }, { "city_id": "65", "name": "Taiz", "coords": { "lat": "13.4115414", "lon": "43.5570871" } }, { "city_id": "66", "name": "Tehran", "coords": { "lat": "35.6892523", "lon": "51.3896004" } }, { "city_id": "67", "name": "Kabul", "coords": { "lat": "34.5260109", "lon": "69.1776838" } }, { "city_id": "68", "name": "Ulan Bator", "coords": { "lat": "47.9184676", "lon": "106.9177016" } }, { "city_id": "69", "name": "Wellington", "coords": { "lat": "-41.2887953", "lon": "174.7772114" } }, { "city_id": "70", "name": "Trujillo", "coords": { "lat": "-8.1116778", "lon": "-79.0287742" } }, { "city_id": "71", "name": "Arequipa", "coords": { "lat": "-16.3988667", "lon": "-71.5369607" } }, { "city_id": "72", "name": "Lima", "coords": { "lat": "-12.0621065", "lon": "-77.0365256" } }, { "city_id": "73", "name": "Antwerp", "coords": { "lat": "51.2211097", "lon": "4.3997081" } }, { "city_id": "74", "name": "Liverpool", "coords": { "lat": "53.4071991", "lon": "-2.99168" } }, { "city_id": "75", "name": "Montpellier", "coords": { "lat": "43.6112422", "lon": "3.8767337" } }, { "city_id": "76", "name": "Strasbourg", "coords": { "lat": "48.584614", "lon": "7.7507127" } }, { "city_id": "77", "name": "Ghent", "coords": { "lat": "51.0538286", "lon": "3.7250121" } }, { "city_id": "78", "name": "Davao", "coords": { "lat": "7.0645451", "lon": "125.6084371" } }, { "city_id": "79", "name": "Manaus", "coords": { "lat": "-3.1316333", "lon": "-59.9825041" } }, { "city_id": "80", "name": "Cochabamba", "coords": { "lat": "-17.401245799999998", "lon": "-66.1676392078777" } }, { "city_id": "81", "name": "Caloocan", "coords": { "lat": "14.6513225", "lon": "120.9722957" } }, { "city_id": "82", "name": "Cebu", "coords": { "lat": "10.45", "lon": "123.84" } }, { "city_id": "83", "name": "Madurai", "coords": { "lat": "9.9261153", "lon": "78.1140983" } }, { "city_id": "84", "name": "Agra", "coords": { "lat": "27.1752554", "lon": "78.0098161" } }, { "city_id": "85", "name": "Coimbatore", "coords": { "lat": "11.0018115", "lon": "76.9628425" } }, { "city_id": "86", "name": "Marrakesh", "coords": { "lat": "31.6258257", "lon": "-7.9891608" } }, { "city_id": "87", "name": "Manchester", "coords": { "lat": "53.4794892", "lon": "-2.2451148" } }, { "city_id": "88", "name": "Marseille", "coords": { "lat": "43.2961743", "lon": "5.3699525" } }, { "city_id": "89", "name": "Toulouse", "coords": { "lat": "43.6044622", "lon": "1.4442469" } }, { "city_id": "90", "name": "Milan", "coords": { "lat": "45.4668", "lon": "9.1905" } }, { "city_id": "91", "name": "Naples", "coords": { "lat": "40.8359336", "lon": "14.2487826" } }, { "city_id": "92", "name": "Bruges", "coords": { "lat": "51.2085526", "lon": "3.226772" } }, { "city_id": "93", "name": "Nice", "coords": { "lat": "43.7009358", "lon": "7.2683912" } }, { "city_id": "94", "name": "Cannes", "coords": { "lat": "43.5515198", "lon": "7.0134418" } }, { "city_id": "95", "name": "Volgograd", "coords": { "lat": "48.7081906", "lon": "44.5153353" } }, { "city_id": "96", "name": "Voronezh", "coords": { "lat": "51.6605982", "lon": "39.2005858" } }, { "city_id": "97", "name": "Perm", "coords": { "lat": "58.5951603", "lon": "56.3159546" } }, { "city_id": "98", "name": "Krasnoyarsk", "coords": { "lat": "63.3233807", "lon": "97.0979974" } }, { "city_id": "99", "name": "Las Vegas", "coords": { "lat": "36.1672559", "lon": "-115.148516" } }, { "city_id": "100", "name": "Ufa", "coords": { "lat": "54.7261409", "lon": "55.947499" } }, { "city_id": "101", "name": "Barranquilla", "coords": { "lat": "10.9799669", "lon": "-74.8013085" } }, { "city_id": "102", "name": "Cartagena", "coords": { "lat": "10.4195841", "lon": "-75.5271224" } }, { "city_id": "103", "name": "Seville", "coords": { "lat": "37.3886303", "lon": "-5.9953403" } }, { "city_id": "104", "name": "Rostov-on-Don", "coords": { "lat": "47.2213858", "lon": "39.7114196" } }, { "city_id": "105", "name": "Samara", "coords": { "lat": "53.198627", "lon": "50.113987" } }, { "city_id": "106", "name": "Omsk", "coords": { "lat": "54.991375", "lon": "73.371529" } }, { "city_id": "107", "name": "Chelyabinsk", "coords": { "lat": "55.1598408", "lon": "61.4025547" } }, { "city_id": "108", "name": "Kazan", "coords": { "lat": "55.7823547", "lon": "49.1242266" } }, { "city_id": "109", "name": "Nizhny Novgorod", "coords": { "lat": "56.3264816", "lon": "44.0051395" } }, { "city_id": "110", "name": "Yekaterinburg", "coords": { "lat": "56.839104", "lon": "60.60825" } }, { "city_id": "111", "name": "Novosibirsk", "coords": { "lat": "55.0282171", "lon": "82.9234509" } }, { "city_id": "112", "name": "Saint Petersburg", "coords": { "lat": "59.938732", "lon": "30.316229" } }, { "city_id": "113", "name": "Brussels", "coords": { "lat": "50.8465573", "lon": "4.351697" } }, { "city_id": "114", "name": "Nantes", "coords": { "lat": "47.2186371", "lon": "-1.5541362" } }, { "city_id": "115", "name": "Masvingo", "coords": { "lat": "-20.307118600000003", "lon": "30.88137696875768" } }, { "city_id": "116", "name": "Brighton", "coords": { "lat": "50.8214626", "lon": "-0.1400561" } }, { "city_id": "117", "name": "Rennes", "coords": { "lat": "48.1113387", "lon": "-1.6800198" } }, { "city_id": "118", "name": "Nuuk", "coords": { "lat": "64.175029", "lon": "-51.7355386" } }, { "city_id": "119", "name": "Brampton", "coords": { "lat": "43.6858146", "lon": "-79.7599337" } }, { "city_id": "120", "name": "Ottawa", "coords": { "lat": "45.4211435", "lon": "-75.6900574" } }, { "city_id": "121", "name": "Montreal", "coords": { "lat": "45.5031824", "lon": "-73.5698065" } }, { "city_id": "122", "name": "Poznan", "coords": { "lat": "52.4006632", "lon": "16.91973259178088" } }, { "city_id": "123", "name": "Wroclaw", "coords": { "lat": "51.1089776", "lon": "17.0326689" } }, { "city_id": "124", "name": "Kharkiv", "coords": { "lat": "49.9902794", "lon": "36.2303893" } }, { "city_id": "125", "name": "Dnipro", "coords": { "lat": "48.4680221", "lon": "35.0417711" } }, { "city_id": "126", "name": "Odessa", "coords": { "lat": "46.4873195", "lon": "30.7392776" } }, { "city_id": "127", "name": "Donetsk", "coords": { "lat": "48.0158753", "lon": "37.8013407" } }, { "city_id": "128", "name": "Anchorage", "coords": { "lat": "61.2163129", "lon": "-149.894852" } }, { "city_id": "129", "name": "Managua", "coords": { "lat": "12.1459907", "lon": "-86.2746665" } }, { "city_id": "130", "name": "Los Angeles", "coords": { "lat": "34.0536909", "lon": "-118.242766" } }, { "city_id": "131", "name": "Nouakchott", "coords": { "lat": "18.0792379", "lon": "-15.9780071" } }, { "city_id": "132", "name": "Douala", "coords": { "lat": "4.0429408", "lon": "9.706203" } }, { "city_id": "133", "name": "Kuala Lumpur", "coords": { "lat": "3.1516964", "lon": "101.6942371" } }, { "city_id": "134", "name": "St. Louis", "coords": { "lat": "38.6529545", "lon": "-90.24111656024635" } }, { "city_id": "135", "name": "Baltimore", "coords": { "lat": "39.2908816", "lon": "-76.610759" } }, { "city_id": "136", "name": "Bariloche", "coords": { "lat": "-41.1334421", "lon": "-71.3098425" } }, { "city_id": "137", "name": "Cabinda", "coords": { "lat": "-5.5576435", "lon": "12.1919468" } }, { "city_id": "138", "name": "Toamasina", "coords": { "lat": "-18.1553985", "lon": "49.4098352" } }, { "city_id": "139", "name": "San Diego", "coords": { "lat": "32.7174202", "lon": "-117.1627728" } }, { "city_id": "140", "name": "Giza", "coords": { "lat": "29.9870753", "lon": "31.2118063" } }, { "city_id": "141", "name": "Taipei", "coords": { "lat": "25.0375198", "lon": "121.5636796" } }, { "city_id": "142", "name": "El Nido", "coords": { "lat": "11.1800079", "lon": "119.3904846" } }, { "city_id": "143", "name": "Amman", "coords": { "lat": "31.9515694", "lon": "35.9239625" } }, { "city_id": "144", "name": "Vladivostok", "coords": { "lat": "43.1150678", "lon": "131.8855768" } }, { "city_id": "145", "name": "Munich", "coords": { "lat": "48.1371079", "lon": "11.5753822" } }, { "city_id": "146", "name": "Zagreb", "coords": { "lat": "45.8131847", "lon": "15.9771774" } }, { "city_id": "147", "name": "Salvador", "coords": { "lat": "-12.9822499", "lon": "-38.4812772" } }, { "city_id": "148", "name": "Mons", "coords": { "lat": "50.4549568", "lon": "3.951958" } }, { "city_id": "149", "name": "Newport", "coords": { "lat": "51.5882332", "lon": "-2.9974967" } }, { "city_id": "150", "name": "Venice", "coords": { "lat": "45.4371908", "lon": "12.3345898" } }, { "city_id": "151", "name": "Busan", "coords": { "lat": "35.1799528", "lon": "129.0752365" } }, { "city_id": "152", "name": "Rotterdam", "coords": { "lat": "51.9244424", "lon": "4.47775" } }, { "city_id": "153", "name": "Zaragoza", "coords": { "lat": "41.6521342", "lon": "-0.8809428" } }, { "city_id": "154", "name": "Hamburg", "coords": { "lat": "53.550341", "lon": "10.000654" } }, { "city_id": "155", "name": "Tainan", "coords": { "lat": "22.9912348", "lon": "120.184982" } }, { "city_id": "156", "name": "Bukavu", "coords": { "lat": "-11.6436549", "lon": "27.5186397" } }, { "city_id": "157", "name": "Lubumbashi", "coords": { "lat": "-11.637710949999999", "lon": "27.518630487626254" } }, { "city_id": "158", "name": "Barcelona", "coords": { "lat": "41.3828939", "lon": "2.1774322" } }, { "city_id": "159", "name": "Verona", "coords": { "lat": "45.4384958", "lon": "10.9924122" } }, { "city_id": "160", "name": "Goyang", "coords": { "lat": "37.6581862", "lon": "126.8319452" } }, { "city_id": "161", "name": "Yongin", "coords": { "lat": "37.2405741", "lon": "127.1785572" } }, { "city_id": "162", "name": "Seongnam", "coords": { "lat": "37.4201556", "lon": "127.1262092" } }, { "city_id": "163", "name": "Bucheon", "coords": { "lat": "37.4841098", "lon": "126.7827347" } }, { "city_id": "164", "name": "Changwon", "coords": { "lat": "35.227956", "lon": "128.6818586" } }, { "city_id": "165", "name": "Ulsan", "coords": { "lat": "35.5391697", "lon": "129.3119136" } }, { "city_id": "166", "name": "Prague", "coords": { "lat": "50.0596288", "lon": "14.446459273258009" } }, { "city_id": "167", "name": "Cluj-Napoca", "coords": { "lat": "46.769379", "lon": "23.5899542" } }, { "city_id": "168", "name": "Goteborg", "coords": { "lat": "57.7072326", "lon": "11.9670171" } }, { "city_id": "169", "name": "Zarqa", "coords": { "lat": "32.0668425", "lon": "36.0885771" } }];

// store
const store = useStore();

const cities_with_coords = computed(() => {
    return store.get_cities.map((c, idx) => {
        let lat = parseFloat(CACHED_CITY_COORDS[idx]["coords"]["lat"]);
        let lon = parseFloat(CACHED_CITY_COORDS[idx]["coords"]["lon"]);
        return { ...c, lat, lon };
    });
});
</script>

<template>
    <div style="height: 75vh; width: vw">
        <l-map v-model="zoom" v-model:zoom="zoom" :center="[47.41322, -1.219482]">
            <l-tile-layer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"></l-tile-layer>

            <l-marker
                v-for="city in cities_with_coords"
                :lat-lng="[city.lat, city.lon]"
                draggable
                @moveend="log('moveend')"
            >
                <l-tooltip>{{ city.name }}</l-tooltip>
            </l-marker>
        </l-map>
    </div>
</template>
